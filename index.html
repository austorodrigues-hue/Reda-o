
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteMaster AI - Treinador de Redação</title>
    <!-- Tailwind CSS para Estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }
        .serif {
            font-family: 'Lora', serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .shadow-soft {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3"
  }
}
</script>
</head>
<body class="min-h-screen">
    <div id="app"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useCallback, useMemo, useRef } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai';

        const html = htm.bind(h);

        // --- Constantes ---
        const STORAGE_KEY = 'writemaster_github_v1';
        const TIMER_PRESETS = {
            work: 25 * 60,
            short: 5 * 60,
            long: 15 * 60,
            challenge: 60 * 60
        };

        // --- Componente de Cronômetro ---
        function PomodoroTimer({ onTimeUp }) {
            const [mode, setMode] = useState('work');
            const [seconds, setSeconds] = useState(TIMER_PRESETS.work);
            const [isActive, setIsActive] = useState(false);

            useEffect(() => {
                let interval;
                if (isActive && seconds > 0) {
                    interval = setInterval(() => setSeconds(s => s - 1), 1000);
                } else if (seconds === 0) {
                    setIsActive(false);
                    if (onTimeUp) onTimeUp();
                }
                return () => clearInterval(interval);
            }, [isActive, seconds]);

            const changeMode = (m) => {
                setMode(m);
                setSeconds(TIMER_PRESETS[m]);
                setIsActive(false);
            };

            const format = (s) => {
                const mins = Math.floor(s / 60);
                const secs = s % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            return html`
                <div class="glass p-6 rounded-3xl shadow-soft flex flex-col items-center gap-6">
                    <div class="flex bg-slate-100 p-1 rounded-xl w-full">
                        ${['work', 'short', 'long', 'challenge'].map(m => html`
                            <button 
                                key=${m}
                                onClick=${() => changeMode(m)}
                                class="flex-1 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${mode === m ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}"
                            >
                                ${m === 'work' ? 'Pomo' : m === 'short' ? 'Curta' : m === 'long' ? 'Longa' : 'Redação'}
                            </button>
                        `)}
                    </div>
                    <div class="text-6xl font-black text-slate-900 tabular-nums">${format(seconds)}</div>
                    <div class="flex gap-2 w-full">
                        <button 
                            onClick=${() => setIsActive(!isActive)}
                            class="flex-1 py-3 rounded-2xl font-bold text-white transition-all transform active:scale-95 ${isActive ? 'bg-orange-500' : 'bg-indigo-600'}"
                        >
                            ${isActive ? 'Pausar' : 'Iniciar'}
                        </button>
                        <button onClick=${() => setSeconds(TIMER_PRESETS[mode])} class="p-3 bg-slate-200 rounded-2xl text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Componente Principal App ---
        function App() {
            const [tab, setTab] = useState('editor');
            const [essay, setEssay] = useState({ title: '', content: '', notes: '' });
            const [history, setHistory] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [toast, setToast] = useState('');

            // Persistência
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setHistory(parsed.history || []);
                    if (parsed.draft) setEssay(parsed.draft);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ history, draft: essay }));
            }, [essay, history]);

            const showMsg = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(''), 3000);
            };

            const analyze = async () => {
                if (essay.content.length < 300) return alert("Escreva ao menos 300 caracteres.");
                setIsAnalyzing(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `Analise como corretor oficial do ENEM a redação: "${essay.title}". Texto: ${essay.content}`,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.OBJECT,
                                properties: {
                                    score: { type: Type.NUMBER },
                                    competencies: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { label: { type: Type.STRING }, score: { type: Type.NUMBER }, comment: { type: Type.STRING } } } },
                                    general: { type: Type.STRING },
                                    tips: { type: Type.ARRAY, items: { type: Type.STRING } }
                                }
                            }
                        }
                    });
                    setFeedback(JSON.parse(response.text));
                    showMsg("Análise concluída com sucesso!");
                } catch (e) {
                    console.error(e);
                    alert("Erro na análise. Verifique sua conexão.");
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const save = () => {
                if (!essay.content.trim()) return alert("Nada para salvar.");
                const entry = { ...essay, id: Date.now(), date: new Date().toLocaleString(), feedback };
                setHistory([entry, ...history]);
                showMsg("Redação salva no histórico!");
            };

            const download = () => {
                const blob = new Blob([`TÍTULO: ${essay.title}\n\n${essay.content}`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${essay.title || 'redacao'}.txt`;
                a.click();
            };

            return html`
                <div class="min-h-screen flex flex-col">
                    <!-- Header -->
                    <header class="glass sticky top-0 z-50 px-6 py-4 shadow-sm">
                        <div class="max-w-7xl mx-auto flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold">W</div>
                                <h1 class="font-black text-xl tracking-tighter hidden sm:block">WriteMaster <span class="text-indigo-600">AI</span></h1>
                            </div>
                            
                            <nav class="flex bg-slate-200/50 p-1 rounded-2xl">
                                ${['editor', 'history', 'guide'].map(t => html`
                                    <button 
                                        onClick=${() => setTab(t)}
                                        class="px-4 py-2 rounded-xl text-xs font-bold transition-all ${tab === t ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}"
                                    >
                                        ${t.toUpperCase()}
                                    </button>
                                `)}
                            </nav>

                            <div class="flex gap-2">
                                <button onClick=${save} class="hidden sm:flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Salvar</button>
                                <button onClick=${analyze} class="hidden sm:flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Analisar</button>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-7xl mx-auto w-full p-6 flex-1">
                        ${tab === 'editor' && html`
                            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8 animate-fade-in">
                                <div class="xl:col-span-3 space-y-6">
                                    <div class="glass p-2 rounded-2xl">
                                        <input 
                                            class="w-full text-2xl font-bold p-4 bg-transparent outline-none text-slate-900" 
                                            placeholder="Título da Redação..."
                                            value=${essay.title}
                                            onInput=${e => setEssay({...essay, title: e.target.value})}
                                        />
                                    </div>
                                    <div class="relative">
                                        <textarea 
                                            class="serif w-full h-[500px] p-8 glass rounded-3xl outline-none text-lg leading-relaxed text-slate-800 shadow-inner resize-none"
                                            placeholder="Comece sua escrita..."
                                            value=${essay.content}
                                            onInput=${e => setEssay({...essay, content: e.target.value})}
                                        ></textarea>
                                        <div class="absolute bottom-4 right-6 text-[10px] font-bold text-slate-400 bg-white/80 px-3 py-1 rounded-full">
                                            ${essay.content.length} caracteres
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap gap-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                        <button onClick=${save} class="px-8 py-4 bg-emerald-600 text-white rounded-2xl font-black text-sm tracking-widest shadow-lg shadow-emerald-100 uppercase">Salvar no Histórico</button>
                                        <button onClick=${download} class="px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold text-sm">Baixar .TXT</button>
                                        <button onClick=${() => setEssay({title:'', content:'', notes:''})} class="px-6 py-4 text-rose-500 font-bold ml-auto">Limpar</button>
                                    </div>

                                    ${feedback && html`
                                        <div class="glass p-8 rounded-[2rem] space-y-8 animate-fade-in shadow-xl">
                                            <div class="flex justify-between items-end border-b pb-6">
                                                <div>
                                                    <h2 class="text-5xl font-black text-indigo-600">${feedback.score}</h2>
                                                    <p class="text-slate-500 font-bold uppercase text-[10px] tracking-widest">Nota Estimada ENEM</p>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                ${feedback.competencies.map(c => html`
                                                    <div class="p-4 bg-white rounded-2xl border border-slate-100">
                                                        <div class="flex justify-between font-bold text-[10px] text-indigo-500 mb-2">
                                                            <span>${c.label}</span>
                                                            <span class="bg-indigo-50 px-2 py-0.5 rounded-full">${c.score}</span>
                                                        </div>
                                                        <p class="text-xs text-slate-600 italic">"${c.comment}"</p>
                                                    </div>
                                                `)}
                                            </div>
                                            <div class="space-y-4">
                                                <h3 class="font-black text-slate-900 text-sm uppercase tracking-widest">Análise Geral</h3>
                                                <p class="bg-white/50 p-6 rounded-2xl text-slate-700 text-sm leading-relaxed">${feedback.general}</p>
                                            </div>
                                            <div class="bg-slate-900 text-white p-8 rounded-3xl">
                                                <h3 class="font-bold text-indigo-400 mb-4">Pontos de Melhoria</h3>
                                                <ul class="text-xs space-y-2 opacity-80">
                                                    ${feedback.tips.map(t => html`<li>• ${t}</li>`)}
                                                </ul>
                                            </div>
                                        </div>
                                    `}
                                </div>

                                <div class="xl:col-span-1 space-y-6">
                                    <${PomodoroTimer} onTimeUp=${() => alert("Tempo de Redação encerrado!")} />
                                    <div class="glass p-6 rounded-3xl space-y-4">
                                        <h4 class="font-bold text-sm text-slate-900 border-b pb-2">Anotações Rápida</h4>
                                        <textarea 
                                            class="w-full h-40 bg-transparent text-xs text-slate-600 outline-none resize-none leading-relaxed"
                                            placeholder="Ideias, citações..."
                                            value=${essay.notes}
                                            onInput=${e => setEssay({...essay, notes: e.target.value})}
                                        ></textarea>
                                    </div>
                                    <div class="bg-indigo-900 p-6 rounded-3xl text-white">
                                        <h4 class="font-bold text-xs mb-4">Checklist Final</h4>
                                        <ul class="text-[10px] space-y-2 opacity-70">
                                            <li><input type="checkbox"/> Título pertinente</li>
                                            <li><input type="checkbox"/> 2 a 3 repertórios</li>
                                            <li><input type="checkbox"/> 5 elementos na proposta</li>
                                            <li><input type="checkbox"/> Conectivos em todos parágrafos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `}

                        ${tab === 'history' && html`
                            <div class="animate-fade-in max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${history.length === 0 ? html`<p class="col-span-full text-center py-20 text-slate-400">Nenhum rascunho salvo ainda.</p>` : 
                                history.map(h => html`
                                    <div key=${h.id} class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:border-indigo-500 transition-all cursor-pointer">
                                        <div class="flex justify-between items-start mb-1">
                                            <h3 class="font-bold text-slate-900 truncate flex-1">${h.title || 'Sem Título'}</h3>
                                            ${h.feedback && html`<span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg">${h.feedback.score}</span>`}
                                        </div>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">${h.date}</p>
                                        <p class="serif text-xs text-slate-500 line-clamp-3 mb-4 leading-relaxed">${h.content}</p>
                                        <div class="flex gap-4">
                                            <button onClick=${() => { setEssay(h); setTab('editor'); setFeedback(h.feedback); }} class="text-xs font-bold text-indigo-600">Editar</button>
                                            <button onClick=${() => setHistory(history.filter(x => x.id !== h.id))} class="text-xs font-bold text-rose-400">Excluir</button>
                                        </div>
                                    </div>
                                `)}
                            </div>
                        `}

                        ${tab === 'guide' && html`
                            <div class="animate-fade-in max-w-3xl mx-auto space-y-8 pb-20">
                                <section class="glass p-8 rounded-[2rem] border-slate-200 shadow-sm">
                                    <h2 class="text-2xl font-black text-slate-900 mb-6">Guia Nota 1000</h2>
                                    <div class="space-y-6 text-sm text-slate-600 leading-relaxed">
                                        <div class="flex gap-4">
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold flex-shrink-0">1</div>
                                            <div>
                                                <h4 class="font-bold text-slate-900">Introdução</h4>
                                                <p>Apresente o tema através de um repertório legitimado e defina claramente sua tese com dois argumentos.</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-4">
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold flex-shrink-0">2</div>
                                            <div>
                                                <h4 class="font-bold text-slate-900">Desenvolvimento</h4>
                                                <p>Utilize um parágrafo para cada argumento. Estrutura: Tópico frasal + Repertório + Explicação + Conclusão do parágrafo.</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-4">
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold flex-shrink-0">3</div>
                                            <div>
                                                <h4 class="font-bold text-slate-900">Conclusão</h4>
                                                <p>Proposta de intervenção completa: Agente, Ação, Meio/Modo, Efeito e Detalhamento de um desses itens.</p>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        `}
                    </main>

                    <!-- Floating Actions (Mobile) -->
                    <div class="fixed bottom-6 right-6 sm:hidden flex flex-col gap-2 z-[60]">
                        <button onClick=${save} class="w-14 h-14 bg-emerald-600 text-white rounded-full shadow-2xl flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg></button>
                        <button onClick=${analyze} class="w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></button>
                    </div>

                    <!-- Toast -->
                    ${toast && html`
                        <div class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[70] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl animate-fade-in font-bold text-sm">
                            ${toast}
                        </div>
                    `}

                    <!-- Loading -->
                    ${isAnalyzing && html`
                        <div class="fixed inset-0 z-[100] bg-white/80 backdrop-blur-md flex flex-col items-center justify-center">
                            <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
                            <h2 class="text-xl font-black text-slate-900">Inteligência Artificial Analisando...</h2>
                            <p class="text-slate-400 text-xs mt-2">Avaliando gramática, coesão e proposta.</p>
                        </div>
                    `}
                </div>
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
